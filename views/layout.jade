doctype html
html(lang='en', ng-app='myApp')
  head
    title Mame High Scores
    meta(name="viewport" content="width=device-width, initial-scale=1")


    //<!-- Latest compiled and minified CSS -->
    link(rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css")
    //<!-- Optional theme -->
    link(rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.1.1/yeti/bootstrap.min.css")

    //link(rel="stylesheet" href="/stylesheets/typeahead.css")
    script(src="//code.jquery.com/jquery-2.1.0.min.js")

    link(rel='stylesheet' href='/css/app.css')

    script(src='js/dependencies/sails.io.js')
    script(src='js/dependencies/angular.js')
    script(src='js/dependencies/angular-route.js')
    script(src='js/dependencies/angular-animate.js')
    script(src='js/dependencies/angular-sails.js')
    script(src='js/dependencies/moment.js')
    script(src='js/dependencies/angular-moment.js')
    script(src='js/dependencies/ui-bootstrap.js')
    script(src='js/dependencies/ui-bootstrap-tpls.js')
    script(src='js/app.js')
    script(src='js/services.js')
    script(src='js/controllers.js')
    script(src='js/filters.js')
    script(src='js/directives.js')
    script(src='//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js')


  body

    .navbar.navbar-default.navbar-fixed-top(role='navigation')
      .container
        .navbar-header
          button.navbar-toggle(type='button', data-toggle='collapse', data-target='.navbar-collapse')
            span.sr-only Toggle navigation
            span.icon-bar
            span.icon-bar
            span.icon-bar
          a.navbar-brand(href='/') Mame High Scores 
            small(style='font-size: 0.5em') (v#{sails.config.globals.version})
        .navbar-collapse.collapse
          ul.nav.navbar-nav
            li
              a(href='#/games') Games
            li
              a(href='#/users') Users
            //li
            //  a(href='#todo') Enter Score
            li 
              a(href='#/game-upload') Upload File
            li
              a(href='#/settings') Settings
            li
              a(href='#/admin') Admin
              
          form.navbar-form.navbar-right(role='search')
            .form-group(ng-controller="SearchCtrl")
              input.form-control.typeahead(type='text', placeholder='Search' ng-model="selected" typeahead="game.full_name for game in games | filter:$viewValue | limitTo:8" typeahead-on-select="onSelected($item, $model, $label)")
              button.btn.btn-default(type='submit') Submit

        // /.nav-collapse
    .container
      .jumbotron
        block body


    //
      In production use:
    //script(src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.21/angular.min.js")

    //script(src="//cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.2/typeahead.bundle.min.js")
    //script(src='/socket.io/socket.io.js')

    script.
      //io.socket.get("/score", function() {});

      io.socket.on("score", function (message) {
        console.log('**got score message**');
        console.log(message);
        if (message.verb === "created") {
          var notificationText = message.data.name + " just set a new high score of " + message.data.score + " on " + message.data.game.full_name;
          var n = new Notification(notificationText,
            { body: "Click here to view the new scores", icon: "/images/notification-icon.png"});
          n.onclick = function() {
            n.close();
            location.href = "/#games/" + message.data.game.id;
          }

          n.onshow = function () {
            setTimeout(function() { n.close() }, 10000);
          }
        }
      });

    //
      script.
        var socket = io();

        socket.on('notification', function(msg){
          var notificationText = msg.topScore.name + " just set a new high score of " + msg.topScore.score + " on " + msg.game.fullName;
          var n = new Notification(notificationText, 
            { body: "Click here to view the new scores", icon: "/images/notification-icon.png"});
          n.onclick = function() {
            n.close();
            location.href = "/game/" + msg.game.name;
          }

          n.onshow = function () { 
            setTimeout(function() { n.close() }, 5000); 
          }
        });

      
        //TODO: move this out of here/wrap up in own function
        var gamesAdapter = new Bloodhound({
          datumTokenizer: function(d) {
            return Bloodhound.tokenizers.whitespace(d.fullName);
          },
          queryTokenizer: Bloodhound.tokenizers.whitespace,
          limit: 10,
          prefetch: { //note this is cached in local storage for 1 day
            url: '/games?allGames=true',
          }
        });
         
        // kicks off the loading/processing of `local` and `prefetch`
        gamesAdapter.initialize();
         
        // passing in `null` for the `options` arguments will result in the default
        // options being used
        $('.typeahead').typeahead({
          hint: true,
          highlight: true,
          minLength: 1
        },
        {
          //name: 'fullName',
          displayKey: 'fullName',
          // `ttAdapter` wraps the suggestion engine in an adapter that
          // is compatible with the typeahead jQuery plugin
          source: gamesAdapter.ttAdapter()
        }).bind('typeahead:selected', function(eventObj, gameObj){ 
          window.location = '/games/' + gameObj.name;
        });

        //super hack to remove the stupid extra styling that typeahead adds
        $('.typeahead').css('vertical-align', '');
        $('.typeahead').css('background-color', '');


